name: Build and Release APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build Release APK
      run: ./gradlew assembleRelease

    - name: Sign APK
      uses: r0adkll/sign-android-release@v1
      # ID used to access action output
      id: sign_app
      with:
        releaseDirectory: app/build/outputs/apk/release
        signingKeyBase64: ${{ secrets.SIGNING_KEY }}
        alias: ${{ secrets.ALIAS }}
        keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
        keyPassword: ${{ secrets.KEY_PASSWORD }}
      env:
        # override default build-tools version (29.0.3) -- optional
        BUILD_TOOLS_VERSION: "34.0.0"

    - name: Generate release tag and build time
      id: tag
      run: |
        echo "release_tag=v$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
        echo "build_time=$(date -u)" >> $GITHUB_OUTPUT

    - name: Rename APK
      id: rename
      run: |
        SIGNED_APK="${{ steps.sign_app.outputs.signedReleaseFile }}"
        APK_DIR=$(dirname "$SIGNED_APK")
        NEW_APK_PATH="$APK_DIR/sms-synology-chat-forwarder.apk"
        mv "$SIGNED_APK" "$NEW_APK_PATH"
        echo "renamed_apk_path=$NEW_APK_PATH" >> $GITHUB_OUTPUT
        ls -la "$APK_DIR"

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        name: SMS Synology Chat Forwarder ${{ steps.tag.outputs.release_tag }}
        body: |
          ## SMS to Synology Chat Forwarder
          
          Automatically built from commit: ${{ github.sha }}
          
          ### Features:
          - Forward incoming SMS to Synology Chat via webhook
          - Background service for reliable operation
          - Battery optimization handling
          - Test webhook functionality
          
          ### Installation:
          1. Download the APK below
          2. Enable "Install from unknown sources" in Android settings
          3. Install the APK
          4. Grant SMS and notification permissions
          5. Configure your Synology Chat webhook URL
          6. Disable battery optimization when prompted
          
          Built on: ${{ steps.tag.outputs.build_time }}
        files: |
          ${{ steps.rename.outputs.renamed_apk_path }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: sms-synology-chat-forwarder
        path: ${{ steps.rename.outputs.renamed_apk_path }}
        retention-days: 30
